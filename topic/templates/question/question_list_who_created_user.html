{% extends "base_generic.html" %}
{% load i18n %}
{% load widget_tweaks %}

{% block content %}
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">{% trans "My Questions List" %}</h5>

                            {% if user.groups.all.0.name == 'professor' %}
                                <a href="{% url 'topic:question-create' %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus"></i> {% trans 'Create a New Question' %}
                                </a>
                            {% endif %}
                        </div>

                        {% if user.groups.all.0.name == 'professor' %}

                            <div class="card bg-light border-0 mb-4">
                                <div class="card-body p-3">
                                    <form method="GET" id="filterForm">
                                        <label class="small font-weight-bold text-muted text-uppercase mb-1">
                                            {% trans "Select a Discipline to view questions" %}
                                        </label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-filter"></i></span>
                                            </div>
                                            <select name="discipline" class="form-control" onchange="document.getElementById('filterForm').submit()">
                                                <option value="">{% trans "--- Choose a Discipline ---" %}</option>
                                                {% for disc in filter_disciplines %}
                                                    <option value="{{ disc.id }}" {% if selected_discipline == disc.id %}selected{% endif %}>
                                                        {{ disc.discipline_name }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            {% if question_list %}
                                <div class="card-body p-0 border rounded mb-5">
                                    <div class="table-responsive">
                                        <table id="example" class="table table-striped table-bordered w-100 mb-0">
                                            <thead class="thead-light">
                                            <tr>
                                                <th scope="col">{% trans "Topic" %}</th>
                                                <th scope="col">{% trans "Type" %}</th>
                                                <th scope="col">{% trans "Group" %}</th>
                                                <th scope="col">{% trans "Dif." %}</th>
                                                <th scope="col">{% trans "Par." %}</th>
                                                <th scope="col">{% trans "ID" %}</th>
                                                <th scope="col">{% trans "Short Description" %}</th>
                                                <th scope="col" class="text-right">{% trans "Actions" %}</th>
                                            </tr>
                                            </thead>

                                            <tbody>
                                            {% for question in question_list %}
                                                <tr>
                                                    <!-- topic -->
                                                    <td>
                                                        <a href="{% url 'topic:topic-detail' pk=question.topic_id %}"
                                                           class="btn btn-outline-warning text-dark btn-sm">
                                                            {{ question.topic }}
                                                        </a>
                                                    </td>

                                                    <!-- question_type -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.topic_id %}"
                                                           class="btn btn-outline-light text-dark btn-sm">
                                                            {{ question.question_type }}
                                                            {% if question.question_type == 'QM' %}
                                                                {{ question.answers2.all|length }}
                                                            {% endif %}
                                                        </a>
                                                    </td>
                                                    <!-- question_group -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.topic_id %}"
                                                           class="btn btn-outline-light text-dark btn-sm">
                                                            {{ question.question_group }}
                                                        </a>
                                                    </td>
                                                    <!-- question_difficulty -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.pk %}"
                                                           class="btn btn-outline-light text-dark btn-sm">
                                                            {{ question.question_difficulty }}
                                                        </a>
                                                    </td>
                                                    <!-- question_parametric -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.pk %}"
                                                           class="btn btn-outline-light text-dark btn-sm">
                                                            {{ question.question_parametric }}
                                                        </a>
                                                    </td>
                                                    <!-- pk -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.pk %}"
                                                           class="btn btn-outline-light text-dark btn-sm">
                                                            {{ question.pk }}
                                                        </a>
                                                    </td>
                                                    <!-- question_short_description -->
                                                    <td>
                                                        <a href="{% url 'topic:question-detail' pk=question.pk %}"
                                                           class="btn btn-outline-info text-dark btn-sm">
                                                            {{ question.question_short_description }}
                                                        </a>
                                                    </td>

                                                    <td class="text-right">

                                                        {% for d in question.topic.discipline.all|slice:":1" %}
                                                            {% if user.is_superuser or user in d.discipline_coords.all or user in d.discipline_profs.all %}
                                                                <!-- Update -->
                                                                <a href="{% url 'topic:question-update'  pk=question.pk %}"
                                                                   class="btn btn-outline-primary btn-sm">
                                                                    {% trans "Update" %}
                                                                </a>

                                                                <!-- Delete -->
                                                                <a href="{% url 'topic:question-delete'  pk=question.pk %}"
                                                                   class="btn btn-outline-danger btn-sm">
                                                                    {% trans "Delete" %}
                                                                </a>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            {% else %}
                                <div class="text-center py-5 text-muted border rounded bg-white mb-5">
                                    <i class="fas fa-search fa-3x mb-3 text-secondary"></i>
                                    {% if request.GET.discipline %}
                                        <h5>{% trans "No questions found for the selected Discipline." %}</h5>
                                    {% else %}
                                        <h5>{% trans "Please select a Discipline above to view your questions." %}</h5>
                                        <p class="mb-0">{% trans "This ensures faster loading times." %}</p>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <hr class="my-5">

                            <div class="mb-5">
                                <h5 class="mb-3"><i class="fas fa-file-alt mr-2"></i> {% trans "Import from TXT (MCTest4 format)" %}</h5>

                                <form action="import/" method="POST" enctype="multipart/form-data" class="mb-3">
                                    {% csrf_token %}
                                    <label for="myfile" class="form-label small mb-1">
                                        {% trans "Choose TXT file" %} <span class="text-muted">({% trans "UTF-8 or Latin-1" %})</span>
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="file" class="form-control" name="myfile" id="myfile" accept=".txt" required>
                                        <button class="btn btn-primary" type="submit">{% trans "Upload TXT" %}</button>
                                    </div>
                                </form>

                                <div class="alert alert-danger py-2 mb-3" role="alert" style="font-size: 0.9em;">
                                    <strong>{% trans "CRITICAL ERROR:" %}</strong>
                                    {% trans "The TOPIC (e.g., '7-matrix') used in the file MUST exist in the system and belong to your Discipline." %}
                                </div>

                                <div class="card bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="card-title mb-1">{% trans "Standard Syntax" %}</h6>
                                        <pre class="border p-2 bg-white text-dark mb-3" style="font-size: 0.85em; line-height: 1.3;">
QE::7-matrix::group A::
<span class="text-muted">%::Type (Multiple Choice: easy, medium, hard — QE/QM/QH — or Text QT)::Topic::Group::</span>
Create a $9\times 5$ integer matrix $A$ where $A_{i,j} = i + j$.
Compute the sum of all entries.
A: 270 <span class="text-success">% Correct — first always</span>
A: 260 <span class="text-danger">% Wrong</span>
A: 280
A: 250</pre>

                                        <hr class="my-2">

                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="card-title mb-1">{% trans "Parametric Syntax" %}</h6>
                                            <span class="badge badge-warning text-dark">{% trans "1 Question per File" %}</span>
                                        </div>

                                        <div class="alert alert-warning py-1 my-2 small border-warning">
                                            <i class="fas fa-exclamation-circle"></i>
                                            {% trans "IMPORTANT: After importing, verify if the 'Parametric' attribute is set to 'YES' in the question details." %}
                                        </div>

                                        <pre class="border p-2 bg-white text-dark mb-0" style="font-size: 0.85em; line-height: 1.3;">
QM::7-matrix::group A::
\begin{problem}
Create a $[[code:R]]\times [[code:C]]$ matrix where $A_{i,j} = i + j$.
Compute the sum of all entries.
\end{problem}

[[def:
import random
R, C = random.randint(5, 9), random.randint(4, 8)

<span class="text-muted"># Calculate Correct Answer</span>
answ = 0
for i in range(R):
    for j in range(C):
        answ += i + j

<span class="text-muted"># Calculate Distractors</span>
w1, w2, w3 = answ + 10, answ - 5, answ * 2
]]
A: [[code:answ]]
A: [[code:w1]]
A: [[code:w2]]
A: [[code:w3]]</pre>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-5">

                            <div class="mb-5">
                                <h5 class="mb-3"><i class="fas fa-file-code mr-2"></i> {% trans "Import from JSON" %}</h5>

                                <form action="/topic/myquestions/importJson/" method="POST" enctype="multipart/form-data" class="mb-3">
                                    {% csrf_token %}

                                    <label for="myfileJson" class="form-label small mb-1">
                                        {% trans "Choose JSON file" %}
                                    </label>

                                    <div class="input-group input-group-sm">
                                        <input type="file" class="form-control" name="myfile" id="myfileJson" accept=".json" required>
                                        <button class="btn btn-primary" type="submit">
                                            {% trans "Upload-Questions-Json" %}
                                        </button>
                                    </div>
                                </form>

                                <p class="small text-muted mb-2">
                                    <i class="fas fa-info-circle"></i> {% trans "Download a question to view the Json format" %}
                                </p>
                            </div>

                        {% endif %}

                        <hr>
                        <div class="text-muted small text-center">
                            {% trans "Questions of the disciplines that I am enrolled" %}<br>
                            {% trans "Contact your discipline coordinator" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}